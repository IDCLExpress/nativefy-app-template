# =============================================================================
# NATIVEFY - Web to Native App Builder
# Production-Quality Codemagic Configuration
# =============================================================================
# This configuration creates native iOS and Android apps from any web URL
# by wrapping them in a high-performance WebView with native capabilities.
# =============================================================================

definitions:
  # Shared environment variables
  environment: &environment
    vars:
      FLUTTER_VERSION: "stable"
      XCODE_VERSION: "latest"
      COCOAPODS_VERSION: "1.14.3"
      NODE_VERSION: "20.10.0"
      
  # Shared caching configuration for faster builds
  cache: &cache
    cache_paths:
      - $HOME/.npm
      - $HOME/.gradle/caches
      - $HOME/Library/Caches/CocoaPods
      - node_modules
      - android/.gradle
      - ios/Pods

  # Shared triggering rules
  triggering: &triggering
    events:
      - push
      - pull_request
      - tag
    branch_patterns:
      - pattern: 'main'
        include: true
      - pattern: 'release/*'
        include: true
    cancel_previous_builds: true

workflows:
  # ===========================================================================
  # ANDROID WORKFLOW - Production Quality
  # ===========================================================================
  android-workflow:
    name: "Android Production Build"
    instance_type: linux
    max_build_duration: 60
    
    <<: *environment
    
    environment:
      java: 17
      node: 20
      vars:
        # These are passed from our edge function
        APP_NAME: ${APP_NAME}
        SOURCE_URL: ${SOURCE_URL}
        BUNDLE_ID: ${BUNDLE_ID}
        PLATFORM: "android"
        
    cache:
      <<: *cache
      
    scripts:
      # -----------------------------------------------------------------------
      # STEP 1: Validate Environment
      # -----------------------------------------------------------------------
      - name: "Validate build parameters"
        script: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           NATIVEFY - Android Build Starting                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± App Name: $APP_NAME"
          echo "ğŸŒ Source URL: $SOURCE_URL"
          echo "ğŸ“¦ Bundle ID: $BUNDLE_ID"
          echo ""
          
          # Validate required variables
          if [ -z "$SOURCE_URL" ]; then
            echo "âŒ ERROR: SOURCE_URL is required"
            exit 1
          fi
          
          if [ -z "$APP_NAME" ]; then
            echo "âŒ ERROR: APP_NAME is required"
            exit 1
          fi
          
          # Validate URL format
          if ! echo "$SOURCE_URL" | grep -qE '^https?://'; then
            echo "âŒ ERROR: SOURCE_URL must be a valid HTTP/HTTPS URL"
            exit 1
          fi
          
          echo "âœ… All parameters validated successfully"

      # -----------------------------------------------------------------------
      # STEP 2: Install Dependencies
      # -----------------------------------------------------------------------
      - name: "Install Node.js dependencies"
        script: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps
          echo "âœ… Dependencies installed"

      # -----------------------------------------------------------------------
      # STEP 3: Configure App Identity
      # -----------------------------------------------------------------------
      - name: "Configure app identity and branding"
        script: |
          echo "ğŸ¨ Configuring app identity..."
          
          # Update capacitor.config.ts with dynamic values
          cat > capacitor.config.ts << EOF
          import { CapacitorConfig } from '@capacitor/cli';
          
          const config: CapacitorConfig = {
            appId: '${BUNDLE_ID}',
            appName: '${APP_NAME}',
            webDir: 'dist',
            bundledWebRuntime: false,
            
            // Production server configuration
            server: {
              url: '${SOURCE_URL}',
              cleartext: true,
              androidScheme: 'https',
              allowNavigation: ['*']
            },
            
            // Android-specific optimizations
            android: {
              allowMixedContent: true,
              captureInput: true,
              webContentsDebuggingEnabled: false,
              
              // Splash screen configuration
              splashScreenSpinnerStyle: 'small',
              splashScreenSpinnerColor: '#ffffff'
            },
            
            // Plugin configurations
            plugins: {
              SplashScreen: {
                launchShowDuration: 2000,
                launchAutoHide: true,
                backgroundColor: '#ffffff',
                androidSplashResourceName: 'splash',
                showSpinner: false,
                splashFullScreen: true,
                splashImmersive: true
              },
              StatusBar: {
                style: 'dark',
                backgroundColor: '#ffffff'
              },
              Keyboard: {
                resize: 'body',
                resizeOnFullScreen: true
              }
            }
          };
          
          export default config;
          EOF
          
          echo "âœ… App identity configured"

      # -----------------------------------------------------------------------
      # STEP 4: Update Android Resources
      # -----------------------------------------------------------------------
      - name: "Update Android app name and resources"
        script: |
          echo "ğŸ“± Updating Android resources..."
          
          # Update strings.xml with app name
          mkdir -p android/app/src/main/res/values
          cat > android/app/src/main/res/values/strings.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${APP_NAME}</string>
              <string name="title_activity_main">${APP_NAME}</string>
              <string name="package_name">${BUNDLE_ID}</string>
              <string name="custom_url_scheme">${BUNDLE_ID}</string>
          </resources>
          EOF
          
          echo "âœ… Android resources updated"

      # -----------------------------------------------------------------------
      # STEP 5: Build Web Assets
      # -----------------------------------------------------------------------
      - name: "Build optimized web assets"
        script: |
          echo "ğŸ—ï¸ Building web assets..."
          npm run build
          echo "âœ… Web assets built"

      # -----------------------------------------------------------------------
      # STEP 6: Sync Capacitor
      # -----------------------------------------------------------------------
      - name: "Sync Capacitor to Android"
        script: |
          echo "ğŸ”„ Syncing Capacitor..."
          npx cap sync android --deployment
          echo "âœ… Capacitor synced"

      # -----------------------------------------------------------------------
      # STEP 7: Build Android Release
      # -----------------------------------------------------------------------
      - name: "Build Android release APK"
        script: |
          echo "ğŸ”¨ Building Android release..."
          cd android
          
          # Build release APK
          ./gradlew assembleRelease \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m" \
            -Dorg.gradle.parallel=true \
            -Dorg.gradle.caching=true \
            --no-daemon
          
          echo "âœ… Android APK built successfully"

      # -----------------------------------------------------------------------
      # STEP 8: Sign APK (auto-generate keystore if not provided)
      # -----------------------------------------------------------------------
      - name: "Sign APK with release keystore"
        script: |
          echo "ğŸ” Checking for signing configuration..."
          
          APK_PATH="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          SIGNED_APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          KEYSTORE_PATH="$HOME/release.keystore"
          
          if [ -f "$APK_PATH" ]; then
            if [ -n "$CM_KEYSTORE" ]; then
              # User provided their own keystore
              echo "ğŸ”‘ Using provided release keystore..."
              echo "$CM_KEYSTORE" | base64 --decode > "$KEYSTORE_PATH"
              KEYSTORE_PASS="$CM_KEYSTORE_PASSWORD"
              KEY_ALIAS="$CM_KEY_ALIAS"
              KEY_PASS="$CM_KEY_PASSWORD"
            else
              # Auto-generate a debug keystore for easy onboarding
              echo "ğŸ”§ Auto-generating signing keystore..."
              echo "   (For Play Store publishing, add your own keystore later)"
              
              # Generate keystore with default values
              KEYSTORE_PASS="nativefy_auto_${BUNDLE_ID//[^a-zA-Z0-9]/_}"
              KEY_ALIAS="nativefy"
              KEY_PASS="$KEYSTORE_PASS"
              
              keytool -genkey -v \
                -keystore "$KEYSTORE_PATH" \
                -alias "$KEY_ALIAS" \
                -keyalg RSA \
                -keysize 2048 \
                -validity 10000 \
                -storepass "$KEYSTORE_PASS" \
                -keypass "$KEY_PASS" \
                -dname "CN=${APP_NAME}, OU=SyncForge, O=Nativefy, L=San Francisco, ST=CA, C=US"
              
              echo "âœ… Auto-generated keystore for testing/sideloading"
            fi
            
            # Sign the APK
            echo "ğŸ”‘ Signing APK..."
            jarsigner -verbose \
              -sigalg SHA256withRSA \
              -digestalg SHA-256 \
              -keystore "$KEYSTORE_PATH" \
              -storepass "$KEYSTORE_PASS" \
              -keypass "$KEY_PASS" \
              "$APK_PATH" \
              "$KEY_ALIAS"
            
            # Align the APK for optimal performance
            echo "ğŸ“ Aligning APK..."
            zipalign -v 4 "$APK_PATH" "$SIGNED_APK_PATH"
            
            echo "âœ… APK signed and aligned successfully"
            
            # If auto-generated, save keystore info for user reference
            if [ -z "$CM_KEYSTORE" ]; then
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  â„¹ï¸  AUTO-GENERATED KEYSTORE INFO                             â•‘"
              echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
              echo "â•‘  This APK uses an auto-generated debug keystore.             â•‘"
              echo "â•‘  Perfect for testing and sideloading!                        â•‘"
              echo "â•‘                                                              â•‘"
              echo "â•‘  For Play Store publishing, add your own keystore:           â•‘"
              echo "â•‘  â€¢ CM_KEYSTORE (base64 encoded)                              â•‘"
              echo "â•‘  â€¢ CM_KEYSTORE_PASSWORD                                      â•‘"
              echo "â•‘  â€¢ CM_KEY_ALIAS                                              â•‘"
              echo "â•‘  â€¢ CM_KEY_PASSWORD                                           â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            fi
          fi

      # -----------------------------------------------------------------------
      # STEP 9: Build AAB for Play Store
      # -----------------------------------------------------------------------
      - name: "Build Android App Bundle (AAB)"
        script: |
          echo "ğŸ“¦ Building Android App Bundle..."
          cd android
          
          ./gradlew bundleRelease \
            -Dorg.gradle.jvmargs="-Xmx4g" \
            -Dorg.gradle.parallel=true \
            --no-daemon
          
          echo "âœ… Android App Bundle built"

    artifacts:
      - android/app/build/outputs/apk/release/*.apk
      - android/app/build/outputs/bundle/release/*.aab
      - android/app/build/outputs/logs/*.txt

    publishing:
      scripts:
        - name: "Build completion notification"
          script: |
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘           âœ… ANDROID BUILD COMPLETE                          â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“± App: $APP_NAME"
            echo "ğŸ“¦ Bundle ID: $BUNDLE_ID"
            echo "ğŸŒ Source: $SOURCE_URL"
            echo ""
            echo "Artifacts are ready for download!"

  # ===========================================================================
  # iOS WORKFLOW - Production Quality
  # ===========================================================================
  ios-workflow:
    name: "iOS Production Build"
    instance_type: mac_mini
    max_build_duration: 90
    
    integrations:
      app_store_connect: nativefy_asc  # App Store Connect API key
    
    environment:
      xcode: latest
      node: 20
      cocoapods: 1.14.3
      vars:
        APP_NAME: ${APP_NAME}
        SOURCE_URL: ${SOURCE_URL}
        BUNDLE_ID: ${BUNDLE_ID}
        PLATFORM: "ios"

    cache:
      <<: *cache
      
    scripts:
      # -----------------------------------------------------------------------
      # STEP 1: Validate Environment
      # -----------------------------------------------------------------------
      - name: "Validate build parameters"
        script: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘             NATIVEFY - iOS Build Starting                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± App Name: $APP_NAME"
          echo "ğŸŒ Source URL: $SOURCE_URL"
          echo "ğŸ“¦ Bundle ID: $BUNDLE_ID"
          echo ""
          
          if [ -z "$SOURCE_URL" ]; then
            echo "âŒ ERROR: SOURCE_URL is required"
            exit 1
          fi
          
          if [ -z "$APP_NAME" ]; then
            echo "âŒ ERROR: APP_NAME is required"
            exit 1
          fi
          
          echo "âœ… All parameters validated"

      # -----------------------------------------------------------------------
      # STEP 2: Install Dependencies
      # -----------------------------------------------------------------------
      - name: "Install Node.js dependencies"
        script: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps
          echo "âœ… Dependencies installed"

      # -----------------------------------------------------------------------
      # STEP 3: Configure App Identity
      # -----------------------------------------------------------------------
      - name: "Configure app identity"
        script: |
          echo "ğŸ¨ Configuring app identity..."
          
          cat > capacitor.config.ts << EOF
          import { CapacitorConfig } from '@capacitor/cli';
          
          const config: CapacitorConfig = {
            appId: '${BUNDLE_ID}',
            appName: '${APP_NAME}',
            webDir: 'dist',
            bundledWebRuntime: false,
            
            server: {
              url: '${SOURCE_URL}',
              cleartext: false,
              iosScheme: 'https',
              allowNavigation: ['*']
            },
            
            ios: {
              contentInset: 'automatic',
              allowsLinkPreview: true,
              scrollEnabled: true,
              limitsNavigationsToAppBoundDomains: false,
              preferredContentMode: 'mobile'
            },
            
            plugins: {
              SplashScreen: {
                launchShowDuration: 2000,
                launchAutoHide: true,
                backgroundColor: '#ffffff',
                showSpinner: false,
                splashFullScreen: true,
                splashImmersive: true
              },
              StatusBar: {
                style: 'dark'
              },
              Keyboard: {
                resize: 'body',
                resizeOnFullScreen: true
              }
            }
          };
          
          export default config;
          EOF
          
          echo "âœ… App identity configured"

      # -----------------------------------------------------------------------
      # STEP 4: Build Web Assets
      # -----------------------------------------------------------------------
      - name: "Build optimized web assets"
        script: |
          echo "ğŸ—ï¸ Building web assets..."
          npm run build
          echo "âœ… Web assets built"

      # -----------------------------------------------------------------------
      # STEP 5: Sync and Prepare iOS
      # -----------------------------------------------------------------------
      - name: "Sync Capacitor to iOS"
        script: |
          echo "ğŸ”„ Syncing Capacitor..."
          npx cap sync ios --deployment
          echo "âœ… Capacitor synced"

      # -----------------------------------------------------------------------
      # STEP 6: Install CocoaPods
      # -----------------------------------------------------------------------
      - name: "Install CocoaPods dependencies"
        script: |
          echo "ğŸ“¦ Installing CocoaPods..."
          cd ios/App
          pod install --repo-update
          echo "âœ… CocoaPods installed"

      # -----------------------------------------------------------------------
      # STEP 7: Update iOS Project Settings
      # -----------------------------------------------------------------------
      - name: "Configure iOS project settings"
        script: |
          echo "âš™ï¸ Configuring iOS project..."
          cd ios/App
          
          # Update display name in Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ${APP_NAME}" App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleName ${APP_NAME}" App/Info.plist
          
          echo "âœ… iOS project configured"

      # -----------------------------------------------------------------------
      # STEP 8: Set Up Code Signing
      # -----------------------------------------------------------------------
      - name: "Set up iOS code signing"
        script: |
          echo "ğŸ” Setting up code signing..."
          xcode-project use-profiles
          echo "âœ… Code signing configured"

      # -----------------------------------------------------------------------
      # STEP 9: Build iOS Archive
      # -----------------------------------------------------------------------
      - name: "Build iOS release archive"
        script: |
          echo "ğŸ”¨ Building iOS archive..."
          cd ios/App
          
          xcodebuild archive \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            -destination 'generic/platform=iOS' \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="$APPLE_PROVISIONING_PROFILE" \
            -allowProvisioningUpdates \
            | xcbeautify
          
          echo "âœ… iOS archive created"

      # -----------------------------------------------------------------------
      # STEP 10: Export IPA
      # -----------------------------------------------------------------------
      - name: "Export IPA for distribution"
        script: |
          echo "ğŸ“¦ Exporting IPA..."
          cd ios/App
          
          # Create export options plist
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>\${APPLE_TEAM_ID}</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist exportOptions.plist \
            | xcbeautify
          
          echo "âœ… IPA exported"

    artifacts:
      - ios/App/build/ipa/*.ipa
      - ios/App/build/*.xcarchive
      - ios/App/build/logs/*.txt

    publishing:
      scripts:
        - name: "Build completion notification"
          script: |
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘             âœ… iOS BUILD COMPLETE                            â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“± App: $APP_NAME"
            echo "ğŸ“¦ Bundle ID: $BUNDLE_ID"
            echo "ğŸŒ Source: $SOURCE_URL"
            echo ""
            echo "IPA is ready for download or App Store submission!"
